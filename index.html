<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strike DD — Mission Control</title>
  <style>
    :root {
      --bg: #0b1020;
      --bg2: #111a2f;
      --card: #131f38;
      --line: #2a3d66;
      --text: #ecf2ff;
      --muted: #9db0d6;
      --accent: #6db8ff;
      --ok: #67e2a8;
      --warn: #ffd172;
      --danger: #ff7f9e;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(800px 500px at 0% -10%, #22457f80, transparent 65%),
        radial-gradient(700px 500px at 110% -5%, #50348a78, transparent 65%),
        var(--bg);
    }
    .wrap { max-width: 1200px; margin: 20px auto; padding: 0 14px 24px; display: grid; gap: 14px; }
    .bar, .card {
      border: 1px solid var(--line);
      background: linear-gradient(180deg, var(--card), var(--bg2));
      border-radius: var(--radius);
    }
    .bar { padding: 14px; display: grid; gap: 8px; }
    h1 { margin: 0; font-size: clamp(22px, 4vw, 34px); }
    .sub { margin: 0; color: var(--muted); }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .pill { border: 1px solid #3b5789; border-radius: 999px; padding: 5px 10px; font-size: 12px; color: #dce8ff; background: #1a2948; }

    .grid { display: grid; grid-template-columns: 1.1fr .9fr; gap: 14px; }
    .card { padding: 12px; min-width: 0; }
    .card h2 { margin: 0 0 10px; font-size: 13px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); }

    .list { display: grid; gap: 8px; }
    .item {
      border: 1px solid #304a78;
      background: #13213d;
      border-radius: 10px;
      padding: 10px;
      display: grid;
      gap: 4px;
    }
    .top { display: flex; justify-content: space-between; gap: 8px; align-items: center; }
    .name { font-weight: 600; }
    .meta { color: var(--muted); font-size: 12px; }
    .tag { border-radius: 999px; padding: 2px 8px; font-size: 11px; text-transform: uppercase; letter-spacing: .05em; border: 1px solid #3c598b; background: #1b2f53; }
    .doing { border-color: #2f6d59; background: #16362f; color: #c9ffea; }
    .ready { border-color: #42669f; background: #1b3157; color: #d9e9ff; }
    .blocked { border-color: #7d4f66; background: #3b2230; color: #ffd8e5; }

    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    button {
      border: 1px solid #3d5d92;
      background: #1a2e53;
      color: var(--text);
      border-radius: 999px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 12px;
    }
    button.active { border-color: #87ccff; background: #214073; }

    .prompt-box {
      border: 1px solid #365583;
      border-radius: 10px;
      background: #111e36;
      padding: 10px;
      min-height: 220px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .prompt-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }

    .empty { color: var(--muted); font-size: 13px; }

    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="bar">
      <h1 id="heroTitle">Mission Control</h1>
      <p class="sub" id="heroSub">Loading…</p>
      <div class="row">
        <span class="pill" id="nowClock">--:--</span>
        <span class="pill" id="attentionCount">Attention: 0</span>
        <span class="pill" id="blockedCount">Blocked: 0</span>
      </div>
    </section>

    <section class="grid">
      <article class="card">
        <h2>What needs attention now</h2>
        <div class="controls">
          <button data-filter="all" class="active">All</button>
          <button data-filter="urgent">Urgent only</button>
        </div>
        <div id="tasks" class="list"></div>
      </article>

      <article class="card">
        <h2>Execution prompt (copy/paste)</h2>
        <div class="controls">
          <button data-prompt="90">Next 90 minutes</button>
          <button data-prompt="s1">Sprint 1 (core fixes)</button>
          <button data-prompt="s2">Sprint 2 (flow integrity)</button>
        </div>
        <div id="prompt" class="prompt-box">Loading prompt…</div>
        <div class="prompt-actions">
          <button id="copyPrompt">Copy prompt</button>
          <button id="refreshPrompt">Regenerate</button>
        </div>
      </article>
    </section>

    <section class="grid">
      <article class="card">
        <h2>Blocked + next action</h2>
        <div id="blocked" class="list"></div>
      </article>
      <article class="card">
        <h2>Recent signal</h2>
        <div id="feed" class="list"></div>
      </article>
    </section>
  </div>

  <script>
    const el = (id) => document.getElementById(id);
    const state = { data: null, filter: 'all', promptMode: '90' };

    async function load() {
      try {
        const res = await fetch('state.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('Failed state');
        const data = await res.json();
        state.data = normalize(data || {});
      } catch {
        state.data = normalize({ heroTitle: 'Mission Control', heroSub: 'Fallback mode', tasks: [], feed: [] });
      }
      render();
    }

    function normalize(d) {
      return {
        heroTitle: d.heroTitle || 'Mission Control',
        heroSub: d.heroSub || 'Execution-first view',
        tasks: Array.isArray(d.tasks) ? d.tasks : [],
        feed: Array.isArray(d.feed) ? d.feed : []
      };
    }

    function priority(s) {
      return s === 'doing' ? 0 : s === 'blocked' ? 1 : s === 'ready' ? 2 : 9;
    }

    function render() {
      const d = state.data;
      el('heroTitle').textContent = d.heroTitle;
      el('heroSub').textContent = d.heroSub;

      const tasks = d.tasks.slice().sort((a,b) => priority(a.status) - priority(b.status));
      const urgent = tasks.filter(t => t.status === 'doing' || t.status === 'blocked');
      const blocked = tasks.filter(t => t.status === 'blocked');

      el('attentionCount').textContent = `Attention: ${urgent.length}`;
      el('blockedCount').textContent = `Blocked: ${blocked.length}`;

      const visible = state.filter === 'urgent' ? urgent : tasks;
      el('tasks').innerHTML = visible.length ? visible.map(taskCard).join('') : '<div class="empty">No tasks in this view.</div>';
      el('blocked').innerHTML = blocked.length ? blocked.map(taskCard).join('') : '<div class="empty">No blockers right now.</div>';

      const feed = d.feed.slice(0, 6);
      el('feed').innerHTML = feed.length
        ? feed.map(f => `<div class="item"><div class="name">${esc(f.text || '')}</div><div class="meta">${esc(f.time || '')} · ${esc(f.level || 'all')}</div></div>`).join('')
        : '<div class="empty">No recent feed items.</div>';

      el('prompt').textContent = buildPrompt(tasks, blocked);
      document.querySelectorAll('[data-filter]').forEach(btn => btn.classList.toggle('active', btn.dataset.filter === state.filter));
    }

    function taskCard(t) {
      const status = esc(t.status || 'ready');
      return `<div class="item">
        <div class="top"><span class="name">${esc(t.name || 'Untitled task')}</span><span class="tag ${status}">${status}</span></div>
        <div class="meta">${esc(t.meta || '')}</div>
      </div>`;
    }

    function buildPrompt(tasks, blocked) {
      const top = tasks.slice(0, 5).map((t, i) => `${i+1}. ${t.name} (${t.status})`).join('\n') || '1. No prioritized tasks found';
      const blockers = blocked.map((b, i) => `${i+1}. ${b.name} — ${b.meta || 'Needs clarification'}`).join('\n') || 'None';

      const sprint1 = `You are implementing Sprint 1 only.\n\nGoals:\n1) Fix decision-gate parity at generate-time.\n2) Return machine-readable promotion-in-progress conflicts and wire frontend resume.\n\nTop priorities from board:\n${top}\n\nBlockers:\n${blockers}\n\nRequired output:\n- concise changelog\n- files changed\n- tests run + results\n- remaining blockers\n- commit hash`;

      const sprint2 = `You are implementing Sprint 2 only.\n\nGoals:\n1) Unify Promote-to-V1 entry with canonical promotion flow.\n2) Preserve deep-link/version continuity across V∞/V1 routes.\n3) Enforce sequential evolution step transitions server-side.\n\nContext priorities:\n${top}\n\nDeliverable:\n- end-to-end flow notes\n- regression tests\n- commit hash`;

      const next90 = `Execute the next 90-minute block.\n\nDo this now:\n${top}\n\nFocus rules:\n- highest risk first\n- no unrelated refactors\n- verify with tests before reporting\n\nBlockers to resolve early:\n${blockers}\n\nDeliver in one response:\n- what shipped\n- what failed\n- exact next action`;

      return state.promptMode === 's1' ? sprint1 : state.promptMode === 's2' ? sprint2 : next90;
    }

    function esc(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    document.querySelectorAll('[data-filter]').forEach(btn => btn.addEventListener('click', () => { state.filter = btn.dataset.filter; render(); }));
    document.querySelectorAll('[data-prompt]').forEach(btn => btn.addEventListener('click', () => { state.promptMode = btn.dataset.prompt; render(); }));

    el('copyPrompt').addEventListener('click', async () => {
      const text = el('prompt').textContent;
      try { await navigator.clipboard.writeText(text); el('copyPrompt').textContent = 'Copied'; setTimeout(() => el('copyPrompt').textContent = 'Copy prompt', 1000); }
      catch { el('copyPrompt').textContent = 'Copy failed'; setTimeout(() => el('copyPrompt').textContent = 'Copy prompt', 1200); }
    });

    el('refreshPrompt').addEventListener('click', () => render());

    function tickClock() {
      el('nowClock').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    tickClock();
    setInterval(tickClock, 1000);

    load();
  </script>
</body>
</html>
