<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#080b12" />
  <meta name="color-scheme" content="dark" />
  <title>Mission Control — Workboard</title>
  <style>
    :root {
      --bg: #080b12;
      --bg-2: #101726;
      --card: #121d31;
      --line: #263650;
      --line-soft: #1d2a42;
      --text: #ecf1ff;
      --muted: #9cafce;
      --accent: #73b8ff;
      --ok: #71e7ad;
      --warn: #ffd57d;
      --danger: #ff8baa;
      --radius: 14px;
      --shadow: 0 12px 28px rgba(0, 0, 0, 0.24);
    }

    * { box-sizing: border-box; }

    html { color-scheme: dark; }

    .skip-link {
      position: absolute;
      left: 10px;
      top: -44px;
      background: #0f2444;
      color: #e6f1ff;
      border: 1px solid #78b8ff;
      border-radius: 8px;
      padding: 8px 10px;
      text-decoration: none;
      z-index: 1000;
    }
    .skip-link:focus-visible { top: 10px; }
    body {
      margin: 0;
      color: var(--text);
      font: 14px/1.45 Inter, ui-sans-serif, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(900px 500px at 0% -15%, #21487f66, transparent 60%),
        radial-gradient(700px 420px at 110% -10%, #6939b255, transparent 65%),
        var(--bg);
    }

    .wrap { max-width: 1380px; margin: 18px auto 26px; padding: 0 14px; display: grid; gap: 14px; }

    .card {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, var(--card), var(--bg-2));
      box-shadow: var(--shadow);
    }

    .topbar { padding: 14px; display: grid; gap: 10px; }
    .title { display: flex; gap: 10px; align-items: baseline; flex-wrap: wrap; }
    h1 { margin: 0; font-size: clamp(22px, 4vw, 34px); }
    .sub { margin: 0; color: var(--muted); }

    .stats, .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .action-notice {
      min-height: 20px;
      font-size: 12px;
      color: var(--muted);
      padding: 2px 2px 0;
    }
    .action-notice[data-level="ok"] { color: var(--ok); }
    .action-notice[data-level="warn"] { color: var(--warn); }
    .action-notice[data-level="info"] { color: #b7d8ff; }

    .ia-map {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
    }
    .ia-step {
      border: 1px solid #36507a;
      background: #11213a;
      border-radius: 10px;
      padding: 8px;
      display: grid;
      gap: 4px;
      align-content: start;
      min-height: 74px;
    }
    .ia-step strong { font-size: 12px; letter-spacing: .02em; }
    .ia-step .k {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid #6db3ff;
      color: #cfe6ff;
      font-size: 11px;
      display: grid;
      place-items: center;
    }

    .quick-nav {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .quick-nav a {
      text-decoration: none;
      color: #d8e6ff;
      border: 1px solid #39567f;
      background: #11223c;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
    }
    .quick-nav a:hover { border-color: #83c4ff; }

    .start-strip {
      border: 1px solid #38557f;
      background: #11233f;
      border-radius: 10px;
      padding: 9px 10px;
      display: grid;
      gap: 7px;
    }
    .start-strip strong {
      font-size: 12px;
      letter-spacing: .03em;
      text-transform: uppercase;
      color: #d9e9ff;
    }
    .start-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .path-strip {
      border: 1px solid #355078;
      background: #11233f;
      border-radius: 10px;
      padding: 8px;
      display: grid;
      gap: 6px;
    }
    .path-title {
      font-size: 11px;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: #cfe4ff;
    }
    .path-items {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .path-item {
      border: 1px solid #3f5f8b;
      background: #172b49;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: #e1edff;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .quick-nav a:focus-visible,
    .btn:focus-visible,
    .task:focus-visible,
    input:focus-visible,
    textarea:focus-visible,
    select:focus-visible {
      outline: 2px solid #9fd2ff;
      outline-offset: 2px;
      box-shadow: 0 0 0 2px #9fd2ff33;
    }
    .pill {
      border: 1px solid #3b5275;
      background: #172742;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      color: #d8e6ff;
    }

    .btn {
      border: 1px solid #3b5782;
      background: #172a4b;
      color: var(--text);
      border-radius: 10px;
      padding: 7px 10px;
      font-size: 12px;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: rgba(115, 184, 255, 0.25);
    }
    .btn:hover { border-color: #83c4ff; }
    .btn.primary { background: #1f4675; border-color: #83c4ff; }
    .btn.warn { background: #4f3a1d; border-color: #9c6d1d; }

    .layout { display: grid; gap: 14px; grid-template-columns: 1.45fr .95fr; }

    .board-wrap { padding: 12px; }
    .board-head { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 8px; flex-wrap: wrap; }
    .board-head-meta { display: grid; gap: 4px; }
    h2, h3 { margin: 0; font-size: 13px; text-transform: uppercase; letter-spacing: .08em; color: var(--muted); }

    .lane-guide {
      border: 1px solid #334c73;
      background: #10203a;
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .lane-guide span {
      border: 1px solid #405d87;
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 11px;
      color: #d9e7ff;
      background: #162946;
      white-space: nowrap;
    }

    .board { display: grid; gap: 10px; grid-template-columns: repeat(4, minmax(0, 1fr)); }
    .lane {
      border: 1px solid var(--line-soft);
      border-radius: 10px;
      background: #0f1a2f;
      min-height: 180px;
      padding: 8px;
      display: grid;
      align-content: start;
      gap: 8px;
      transition: box-shadow 180ms ease, border-color 180ms ease;
    }
    .lane h4 { margin: 0; font-size: 12px; letter-spacing: .05em; text-transform: uppercase; color: #c8dcff; }
    .lane.flash {
      border-color: #88c7ff;
      box-shadow: 0 0 0 2px #88c7ff66 inset;
    }

    .task {
      border: 1px solid #2a4063;
      background: #15253f;
      border-radius: 9px;
      padding: 8px;
      cursor: pointer;
      display: grid;
      gap: 4px;
    }
    .task:hover { border-color: #7ebaff; }
    .task.active { border-color: #9ed0ff; box-shadow: 0 0 0 1px #9ed0ff44 inset; }
    .task-title { font-weight: 600; font-size: 13px; }
    .task-meta { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; gap: 8px; }

    .panel { padding: 12px; display: grid; gap: 12px; align-content: start; }
    .panel-section { border: 1px solid var(--line-soft); border-radius: 10px; padding: 10px; background: #101c32; display: grid; gap: 8px; }

    label { font-size: 12px; color: #c4d9ff; display: grid; gap: 4px; }
    input, textarea, select {
      width: 100%;
      border: 1px solid #39557e;
      border-radius: 8px;
      background: #0d1930;
      color: var(--text);
      padding: 8px;
      font: inherit;
    }
    textarea { min-height: 84px; resize: vertical; }

    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .danger { color: #ffd9e4; background: #3a2230; border-color: #7a4c63; }
    .ok { color: #d8ffe9; background: #18362f; border-color: #2d6d57; }
    .muted { color: var(--muted); }

    .prompt-box {
      white-space: pre-wrap;
      border: 1px solid #35527b;
      border-radius: 8px;
      background: #0f1d35;
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      min-height: 150px;
    }

    .checklist { display: grid; gap: 6px; font-size: 13px; }
    .checklist label { display: flex; gap: 8px; align-items: center; }

    .feed { display: grid; gap: 7px; max-height: 220px; overflow: auto; }
    .feed-item { border: 1px solid #2b4065; border-radius: 8px; padding: 8px; background: #14243f; }
    .feed-item .meta { color: var(--muted); font-size: 12px; }

    .strike-list { margin: 0; padding-left: 18px; display: grid; gap: 4px; }
    .strike-list li { color: #dbe8ff; }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #01040acc;
      padding: 14px;
      overscroll-behavior: contain;
    }
    .modal.show { display: flex; }
    .modal-card { width: min(560px, 100%); }

    .empty { color: var(--muted); font-size: 13px; border: 1px dashed #2f4364; border-radius: 8px; padding: 9px; }

    #workboardSection,
    #taskPanelSection,
    #strikeDeskSection,
    #updatesSection { scroll-margin-top: 16px; }

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0ms !important;
        transition-duration: 0ms !important;
        scroll-behavior: auto !important;
      }
    }

    @media (max-width: 1120px) {
      .layout { grid-template-columns: 1fr; }
      .board { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .ia-map { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 680px) {
      .board { grid-template-columns: 1fr; }
      .ia-map { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <a href="#workboardSection" class="skip-link">Skip to Workboard</a>
  <main class="wrap" id="mainContent">
    <section class="card topbar">
      <div class="title">
        <h1 id="heroTitle">Mission Control</h1>
        <span class="pill" id="clock">--:--</span>
      </div>
      <p class="sub" id="heroSub">Loading workspace…</p>
      <div class="ia-map" aria-label="10-second workflow map">
        <div class="ia-step">
          <span class="k">1</span>
          <strong>Scan lanes</strong>
          <span class="muted" id="iaNow">Pick the top Now task.</span>
        </div>
        <div class="ia-step">
          <span class="k">2</span>
          <strong>Edit task</strong>
          <span class="muted">Click a card to open Task details.</span>
        </div>
        <div class="ia-step">
          <span class="k">3</span>
          <strong>Move flow</strong>
          <span class="muted" id="iaBlocker">Clear blockers before pulling Next.</span>
        </div>
        <div class="ia-step">
          <span class="k">4</span>
          <strong>Share brief</strong>
          <span class="muted">Copy execution brief and run.</span>
        </div>
      </div>
      <nav class="quick-nav" aria-label="Mission Control quick navigation">
        <a href="#workboardSection">Go: Workboard</a>
        <a href="#taskPanelSection">Go: Task details</a>
        <a href="#strikeDeskSection">Go: Strike desk</a>
        <a href="#updatesSection">Go: Recent updates</a>
      </nav>
      <section class="start-strip" aria-label="Mission Control start here">
        <strong>Start here</strong>
        <span class="muted" id="startCue">Loading top action…</span>
        <div class="start-actions">
          <button class="btn primary" id="focusFirstActionBtn">Open first action</button>
          <button class="btn" id="focusNowBtn">Focus top Now</button>
          <button class="btn" id="focusBlockedBtn">Focus top Blocked</button>
          <button class="btn" id="focusNextBtn">Focus top Next</button>
        </div>
      </section>
      <section class="path-strip" aria-label="10-second mission path">
        <span class="path-title">Mission path</span>
        <div class="path-items">
          <span class="path-item" id="pathNow">Now: —</span>
          <span class="path-item" id="pathBlocked">Blocked: —</span>
          <span class="path-item" id="pathNext">Next: —</span>
        </div>
      </section>
      <div class="stats" id="stats"></div>
      <div class="actions">
        <button class="btn primary" id="addTaskBtn">Add task</button>
        <button class="btn" id="copyPromptBtn">Copy execution brief</button>
        <button class="btn" id="exportBtn">Export board JSON</button>
        <button class="btn" id="importBtn">Import board JSON</button>
        <button class="btn warn" id="resetBtn">Reset to baseline</button>
      </div>
      <div class="action-notice" id="actionNotice" data-level="info" aria-live="polite">Ready.</div>
      <input id="importInput" type="file" accept="application/json" style="display:none" />
    </section>

    <section class="layout">
      <article class="card board-wrap" id="workboardSection">
        <div class="board-head">
          <div class="board-head-meta">
            <h2>Workboard</h2>
            <span class="muted" id="boardMeta">No task selected</span>
          </div>
          <div class="row">
            <button class="btn" id="pullNextBtn">Pull top Next → Now</button>
            <button class="btn" id="unblockTopBtn">Unblock top Blocked → Next</button>
          </div>
        </div>
        <div class="lane-guide" id="laneGuide" aria-label="Lane guide">
          <span>Now = executing this cycle</span>
          <span>Next = ready queue</span>
          <span>Blocked = needs unblock action</span>
          <span>Done = shipped + verified</span>
        </div>
        <div class="board" id="board"></div>
      </article>

      <aside class="card panel" id="taskPanelSection">
        <section class="panel-section">
          <h3>Task details</h3>
          <div id="taskEmpty" class="empty">Select a task card to edit details and move status.</div>
          <div id="taskEditor" style="display:none; gap:8px;">
            <label>Title<input id="taskTitle" name="taskTitle" autocomplete="off" /></label>
            <label>Description<textarea id="taskDescription" name="taskDescription" autocomplete="off" placeholder="Describe the task…"></textarea></label>
            <div class="row">
              <label style="flex:1">Status
                <select id="taskStatus" name="taskStatus" autocomplete="off">
                  <option value="now">Now</option>
                  <option value="next">Next</option>
                  <option value="blocked">Blocked</option>
                  <option value="done">Done</option>
                </select>
              </label>
              <label style="flex:1">Priority (1 = highest)<input id="taskPriority" name="taskPriority" type="number" min="1" max="99" inputmode="numeric" autocomplete="off" /></label>
            </div>
            <label>Link (optional)<input id="taskLink" name="taskLink" type="url" autocomplete="off" placeholder="https://example.com/…" /></label>
            <label>Owner<input id="taskOwner" name="taskOwner" autocomplete="off" placeholder="Owner name…" /></label>
            <label>Definition of done<textarea id="taskDoD" name="taskDoD" autocomplete="off" placeholder="One checklist item per line…"></textarea></label>
            <div class="row">
              <button class="btn ok" id="saveTaskBtn">Save task</button>
              <button class="btn" id="openTaskLinkBtn">Open link</button>
              <button class="btn danger" id="deleteTaskBtn">Delete</button>
            </div>
            <div class="row">
              <button class="btn" id="moveNowBtn">Move to Now</button>
              <button class="btn" id="moveNextBtn">Move to Next</button>
              <button class="btn warn" id="moveBlockedBtn">Move to Blocked</button>
              <button class="btn ok" id="moveDoneBtn">Move to Done</button>
            </div>
          </div>
        </section>

        <section class="panel-section">
          <h3>Execution brief</h3>
          <div class="prompt-box" id="prompt"></div>
        </section>

        <section class="panel-section">
          <h3>Validation criteria</h3>
          <div class="checklist" id="criteria"></div>
        </section>

        <section class="panel-section">
          <h3>Heartbeat loop</h3>
          <div class="muted" id="heartbeatSummary">No loop status yet.</div>
        </section>

        <section class="panel-section" id="strikeDeskSection">
          <h3>Strike desk</h3>
          <div class="muted" id="strikePolicy"></div>
          <div>
            <div class="muted">Today focus</div>
            <ul class="strike-list" id="strikeFocus"></ul>
          </div>
          <div class="row">
            <input id="strikeNoteInput" name="strikeNoteInput" autocomplete="off" placeholder="Add strike note / request…" style="flex:1" />
            <button class="btn" id="strikeNoteAddBtn">Add note</button>
          </div>
          <div class="feed" id="strikeNotes"></div>
          <button class="btn" id="copyStrikeBriefBtn">Copy strike brief</button>
        </section>

        <section class="panel-section" id="updatesSection">
          <h3>Recent updates</h3>
          <div class="row">
            <input id="feedInput" name="feedInput" autocomplete="off" placeholder="Add a progress note…" style="flex:1" />
            <button class="btn" id="feedAddBtn">Add</button>
          </div>
          <div class="feed" id="feed"></div>
        </section>
      </aside>
    </section>
  </main>

  <div class="modal" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="createTaskTitle">
    <div class="card panel modal-card">
      <h3 id="createTaskTitle">Create task</h3>
      <label>Title<input id="newTaskTitle" name="newTaskTitle" autocomplete="off" /></label>
      <label>Description<textarea id="newTaskDescription" name="newTaskDescription" autocomplete="off" placeholder="Describe the task…"></textarea></label>
      <div class="row">
        <label style="flex:1">Status
          <select id="newTaskStatus" name="newTaskStatus" autocomplete="off">
            <option value="now">Now</option>
            <option value="next">Next</option>
            <option value="blocked">Blocked</option>
            <option value="done">Done</option>
          </select>
        </label>
        <label style="flex:1">Priority<input id="newTaskPriority" name="newTaskPriority" type="number" min="1" max="99" value="5" inputmode="numeric" autocomplete="off" /></label>
      </div>
      <div class="row">
        <button class="btn primary" id="createTaskConfirmBtn">Create</button>
        <button class="btn" id="createTaskCancelBtn">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'mc:state:v3';
    const LANES = ['now', 'next', 'blocked', 'done'];
    const LANE_LABEL = { now: 'Now', next: 'Next', blocked: 'Blocked', done: 'Done' };

    const qs = (id) => document.getElementById(id);

    const app = {
      baseline: null,
      state: null,
      selectedTaskId: null,
      actionNoticeTimer: null,
      heartbeatChecklist: [
        'Scope stays on making Mission Control genuinely useful for daily execution.',
        'Every clickable control must produce a visible state change.',
        'Execution brief is updated from the real board state.',
        'Top blocker has a concrete next action.',
        'Release only after quick smoke test passes.'
      ]
    };

    function nowClock() {
      qs('clock').textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function createDefaultState(raw = {}) {
      const tasks = Array.isArray(raw.tasks) ? raw.tasks : [];
      return {
        heroTitle: raw.heroTitle || 'Mission Control',
        heroSub: raw.heroSub || 'Execution board',
        validationCriteria: Array.isArray(raw.validationCriteria) ? raw.validationCriteria : [
          'Top priorities are obvious in under 10 seconds.',
          'Every task has owner + next action + definition of done.',
          'Blockers are visible and actionable.',
          'Execution brief can be copied and used immediately.',
          'Board updates persist after refresh.'
        ],
        tasks: tasks.map(normalizeTask),
        feed: Array.isArray(raw.feed) ? raw.feed.slice(0, 30).map(normalizeFeed) : [],
        strikeDesk: normalizeStrikeDesk(raw.strikeDesk || {})
      };
    }

    function normalizeTask(t = {}) {
      return {
        id: t.id || cryptoRandom(),
        title: t.title || t.name || 'Untitled task',
        description: t.description || t.meta || '',
        status: LANES.includes(t.status) ? t.status : 'next',
        priority: Number.isFinite(Number(t.priority)) ? Number(t.priority) : 5,
        owner: t.owner || '',
        link: t.link || '',
        definitionOfDone: Array.isArray(t.definitionOfDone)
          ? t.definitionOfDone
          : String(t.definitionOfDone || '').split('\n').map((s) => s.trim()).filter(Boolean),
      };
    }

    function normalizeFeed(f = {}) {
      return {
        id: f.id || cryptoRandom(),
        text: String(f.text || '').trim() || 'Update',
        time: f.time || new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        level: f.level || 'info'
      };
    }

    function normalizeStrikeDesk(raw = {}) {
      const normalizeList = (arr, fallback = []) => {
        if (!Array.isArray(arr)) return fallback;
        return arr.map((x) => String(x || '').trim()).filter(Boolean).slice(0, 12);
      };

      return {
        policy: String(raw.policy || 'Rule: Mission Control can coordinate Strike, but do not edit Strike product code (frontend/src, backend/src).').trim(),
        focus: normalizeList(raw.focus, [
          'Capture incidents + triage priorities',
          'Draft Claude Code execution prompts for Jul',
          'Prepare daily VC + market brief',
        ]),
        notes: normalizeList(raw.notes, []),
      };
    }

    function cryptoRandom() {
      return Math.random().toString(36).slice(2, 10);
    }

    async function loadBaseline() {
      try {
        const res = await fetch('state.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('State load failed');
        return await res.json();
      } catch {
        return {};
      }
    }

    function loadPersisted() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
      } catch {
        return null;
      }
    }

    function persist() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(app.state));
    }

    function getTaskById(id) {
      return app.state.tasks.find((t) => t.id === id) || null;
    }

    function sortedTasks(status) {
      return app.state.tasks
        .filter((t) => t.status === status)
        .sort((a, b) => a.priority - b.priority || a.title.localeCompare(b.title));
    }

    function renderBoard() {
      const board = qs('board');
      board.innerHTML = LANES.map((lane) => {
        const tasks = sortedTasks(lane);
        const cards = tasks.length
          ? tasks.map((t) => {
              const active = t.id === app.selectedTaskId ? 'active' : '';
              return `<button class="task ${active}" data-task-id="${escapeHtml(t.id)}">
                <span class="task-title">${escapeHtml(t.title)}</span>
                <span class="task-meta">
                  <span>P${escapeHtml(String(t.priority))}</span>
                  <span>${escapeHtml(t.owner || 'unassigned')}</span>
                </span>
              </button>`;
            }).join('')
          : '<div class="empty">No tasks</div>';
        return `<section class="lane" data-lane="${lane}">
          <h4>${LANE_LABEL[lane]} (${tasks.length})</h4>
          ${cards}
        </section>`;
      }).join('');

      board.querySelectorAll('[data-task-id]').forEach((el) => {
        el.addEventListener('click', () => {
          app.selectedTaskId = el.getAttribute('data-task-id');
          render();
        });
      });
    }

    function renderStats() {
      const count = Object.fromEntries(LANES.map((lane) => [lane, sortedTasks(lane).length]));
      qs('stats').innerHTML = [
        `<span class="pill">Now: ${count.now}</span>`,
        `<span class="pill">Next: ${count.next}</span>`,
        `<span class="pill">Blocked: ${count.blocked}</span>`,
        `<span class="pill">Done: ${count.done}</span>`,
      ].join('');
      qs('heroTitle').textContent = app.state.heroTitle;
      qs('heroSub').textContent = app.state.heroSub;
      qs('boardMeta').textContent = app.selectedTaskId ? `Editing ${getTaskById(app.selectedTaskId)?.title || 'task'}` : 'No task selected';

      const topNow = sortedTasks('now')[0];
      const topNext = sortedTasks('next')[0];
      const topBlocked = sortedTasks('blocked')[0];
      qs('iaNow').textContent = topNow ? `Start with: ${topNow.title}` : 'No Now task. Promote one from Next.';
      qs('iaBlocker').textContent = topBlocked
        ? `Top blocker: ${topBlocked.title}`
        : 'No blockers. Pull next highest-priority task.';
      qs('startCue').textContent = topNow
        ? `Open “${topNow.title}” in Task details, then save or move.`
        : topBlocked
          ? `No Now task. Clear blocker “${topBlocked.title}” first.`
          : topNext
            ? `No Now task. Promote “${topNext.title}” from Next.`
            : 'Add a task to begin execution flow.';

      qs('pathNow').textContent = topNow ? `Now: ${topNow.title}` : 'Now: none';
      qs('pathBlocked').textContent = topBlocked ? `Blocked: ${topBlocked.title}` : 'Blocked: none';
      qs('pathNext').textContent = topNext ? `Next: ${topNext.title}` : 'Next: none';
    }

    function renderTaskEditor() {
      const task = app.selectedTaskId ? getTaskById(app.selectedTaskId) : null;
      const empty = qs('taskEmpty');
      const editor = qs('taskEditor');
      if (!task) {
        empty.style.display = 'block';
        editor.style.display = 'none';
        return;
      }

      empty.style.display = 'none';
      editor.style.display = 'grid';
      qs('taskTitle').value = task.title;
      qs('taskDescription').value = task.description;
      qs('taskStatus').value = task.status;
      qs('taskPriority').value = String(task.priority);
      qs('taskLink').value = task.link || '';
      qs('taskOwner').value = task.owner || '';
      qs('taskDoD').value = task.definitionOfDone.join('\n');
    }

    function buildExecutionBrief() {
      const now = sortedTasks('now').slice(0, 5);
      const next = sortedTasks('next').slice(0, 4);
      const blocked = sortedTasks('blocked').slice(0, 4);

      const fmt = (arr) => arr.length ? arr.map((t, i) => `${i + 1}. ${t.title} (P${t.priority})`).join('\n') : 'None';

      return [
        'Mission Control — execution brief',
        '',
        'Do now:',
        fmt(now),
        '',
        'Queue next:',
        fmt(next),
        '',
        'Blockers to clear first:',
        blocked.length ? blocked.map((t, i) => `${i + 1}. ${t.title} -> ${t.description || 'add concrete unblock action'}`).join('\n') : 'None',
        '',
        'Required report format:',
        '- shipped changes',
        '- validation evidence',
        '- blockers that remain',
        '- exact next action',
      ].join('\n');
    }

    function renderPrompt() {
      qs('prompt').textContent = buildExecutionBrief();
    }

    function renderCriteria() {
      qs('criteria').innerHTML = app.state.validationCriteria.map((c, idx) => (
        `<label><input type="checkbox" data-criteria-index="${idx}"/> ${escapeHtml(c)}</label>`
      )).join('') + '<div class="muted">(Checklist state is session-only.)</div>';
    }

    function renderHeartbeat() {
      const blockers = sortedTasks('blocked');
      const topBlocker = blockers[0];
      const summary = [
        `Loop standard: ${app.heartbeatChecklist.length} checks every heartbeat.`,
        topBlocker ? `Top blocker: ${topBlocker.title}. Next action: ${topBlocker.description || 'Define unblock step.'}` : 'No blockers. Move next item from queue into Now.',
      ].join(' ');
      qs('heartbeatSummary').textContent = summary;
    }

    function renderFeed() {
      const feed = app.state.feed.slice().reverse();
      qs('feed').innerHTML = feed.length
        ? feed.map((f) => `<div class="feed-item"><div>${escapeHtml(f.text)}</div><div class="meta">${escapeHtml(f.time)} · ${escapeHtml(f.level)}</div></div>`).join('')
        : '<div class="empty">No updates yet.</div>';
    }

    function buildStrikeBrief() {
      const now = sortedTasks('now').slice(0, 3).map((t, i) => `${i + 1}. ${t.title}`).join('\n') || 'None';
      const blocked = sortedTasks('blocked').slice(0, 2).map((t, i) => `${i + 1}. ${t.title}`).join('\n') || 'None';
      const notes = app.state.strikeDesk.notes.length
        ? app.state.strikeDesk.notes.slice(-4).map((n, i) => `${i + 1}. ${n}`).join('\n')
        : 'None';

      return [
        'Strike Brief — operator snapshot',
        '',
        `Policy: ${app.state.strikeDesk.policy}`,
        '',
        'Top Now:',
        now,
        '',
        'Current Blockers:',
        blocked,
        '',
        'Recent Strike notes:',
        notes,
      ].join('\n');
    }

    function renderStrikeDesk() {
      const desk = app.state.strikeDesk || normalizeStrikeDesk();
      qs('strikePolicy').textContent = desk.policy;
      qs('strikeFocus').innerHTML = desk.focus.length
        ? desk.focus.map((item) => `<li>${escapeHtml(item)}</li>`).join('')
        : '<li>No focus items yet.</li>';;
      qs('strikeNotes').innerHTML = desk.notes.length
        ? desk.notes.slice().reverse().map((n) => `<div class="feed-item">${escapeHtml(n)}</div>`).join('')
        : '<div class="empty">No strike notes yet.</div>';;
    }

    function flashAction(text, level = 'info') {
      const notice = qs('actionNotice');
      if (!notice) return;
      notice.textContent = text;
      notice.dataset.level = level;
      if (app.actionNoticeTimer) clearTimeout(app.actionNoticeTimer);
      app.actionNoticeTimer = setTimeout(() => {
        notice.textContent = 'Ready.';
        notice.dataset.level = 'info';
      }, 1800);
    }

    function hasUnsavedTaskChanges() {
      const task = getTaskById(app.selectedTaskId);
      const editorVisible = qs('taskEditor')?.style.display === 'grid';
      if (!task || !editorVisible) return false;

      const currentTitle = (qs('taskTitle')?.value || '').trim() || 'Untitled task';
      const currentDescription = (qs('taskDescription')?.value || '').trim();
      const currentStatus = qs('taskStatus')?.value || 'next';
      const currentPriority = Math.max(1, Math.min(99, Number(qs('taskPriority')?.value) || 5));
      const currentLink = (qs('taskLink')?.value || '').trim();
      const currentOwner = (qs('taskOwner')?.value || '').trim();
      const currentDoD = (qs('taskDoD')?.value || '').split('\n').map((s) => s.trim()).filter(Boolean);

      if (currentTitle !== task.title) return true;
      if (currentDescription !== task.description) return true;
      if (currentStatus !== task.status) return true;
      if (currentPriority !== task.priority) return true;
      if (currentLink !== task.link) return true;
      if (currentOwner !== task.owner) return true;
      if (JSON.stringify(currentDoD) !== JSON.stringify(task.definitionOfDone || [])) return true;
      return false;
    }

    function render() {
      renderStats();
      renderBoard();
      renderTaskEditor();
      renderPrompt();
      renderCriteria();
      renderHeartbeat();
      renderStrikeDesk();
      renderFeed();
    }

    function flashLane(status) {
      const lane = document.querySelector(`.lane[data-lane="${status}"]`);
      if (!lane) return;
      lane.classList.remove('flash');
      requestAnimationFrame(() => {
        lane.classList.add('flash');
        setTimeout(() => lane.classList.remove('flash'), 420);
      });
    }

    function moveSelectedTask(status) {
      const task = getTaskById(app.selectedTaskId);
      if (!task) {
        flashAction('Select a task first.', 'warn');
        return false;
      }
      if (!LANES.includes(status)) return false;
      if (task.status === status) {
        flashAction(`Task already in ${LANE_LABEL[status]}.`, 'info');
        return false;
      }
      task.status = status;
      addFeed(`Task moved to ${LANE_LABEL[status]}: ${task.title}`, 'change');
      persist();
      render();
      flashLane(status);
      flashAction(`Moved task to ${LANE_LABEL[status]}.`, 'ok');
      return true;
    }

    function focusTopTask(status) {
      const top = sortedTasks(status)[0];
      if (!top) {
        flashAction(`No tasks in ${LANE_LABEL[status]} lane.`, 'warn');
        return;
      }
      app.selectedTaskId = top.id;
      render();
      qs('taskPanelSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      flashAction(`Focused top ${LANE_LABEL[status]} task.`, 'ok');
    }

    function focusFirstAction() {
      const candidate = sortedTasks('now')[0] || sortedTasks('blocked')[0] || sortedTasks('next')[0] || null;
      if (!candidate) {
        flashAction('No tasks available. Add a task to start.', 'warn');
        return;
      }
      app.selectedTaskId = candidate.id;
      render();
      qs('taskPanelSection')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      flashAction(`Opened first action: ${candidate.title}.`, 'ok');
    }

    function saveCurrentTask() {
      const task = getTaskById(app.selectedTaskId);
      if (!task) return;
      const previousStatus = task.status;
      task.title = qs('taskTitle').value.trim() || 'Untitled task';
      task.description = qs('taskDescription').value.trim();
      task.status = qs('taskStatus').value;
      task.priority = Math.max(1, Math.min(99, Number(qs('taskPriority').value) || 5));
      task.link = qs('taskLink').value.trim();
      task.owner = qs('taskOwner').value.trim();
      task.definitionOfDone = qs('taskDoD').value.split('\n').map((s) => s.trim()).filter(Boolean);
      addFeed('Task updated: ' + task.title, 'change');
      persist();
      render();
      flashLane(task.status);
      if (previousStatus !== task.status) {
        flashAction(`Saved and moved task to ${LANE_LABEL[task.status]}.`, 'ok');
      } else {
        flashAction('Task saved.', 'ok');
      }
    }

    function addFeed(text, level = 'info') {
      app.state.feed.push(normalizeFeed({ text, level }));
      app.state.feed = app.state.feed.slice(-30);
    }

    function downloadJson(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function escapeHtml(input) {
      return String(input)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function wireActions() {
      window.addEventListener('beforeunload', (evt) => {
        if (!hasUnsavedTaskChanges()) return;
        evt.preventDefault();
        evt.returnValue = '';
      });

      document.querySelectorAll('.quick-nav a').forEach((link) => {
        link.addEventListener('click', (evt) => {
          if (!hasUnsavedTaskChanges()) return;
          if (confirm('You have unsaved task edits. Continue without saving?')) return;
          evt.preventDefault();
        });
      });

      qs('addTaskBtn').addEventListener('click', () => {
        qs('taskModal').classList.add('show');
        flashAction('Create task modal opened.', 'info');
      });
      qs('createTaskCancelBtn').addEventListener('click', () => {
        qs('taskModal').classList.remove('show');
        flashAction('Task creation canceled.', 'info');
      });

      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape' && qs('taskModal').classList.contains('show')) {
          qs('taskModal').classList.remove('show');
          flashAction('Task creation canceled.', 'info');
        }
      });

      qs('createTaskConfirmBtn').addEventListener('click', () => {
        const title = qs('newTaskTitle').value.trim();
        if (!title) return;
        const task = normalizeTask({
          title,
          description: qs('newTaskDescription').value.trim(),
          status: qs('newTaskStatus').value,
          priority: Number(qs('newTaskPriority').value) || 5,
        });
        app.state.tasks.push(task);
        app.selectedTaskId = task.id;
        addFeed('Task created: ' + task.title, 'change');
        persist();
        qs('taskModal').classList.remove('show');
        flashAction('Task created and selected.', 'ok');
        qs('newTaskTitle').value = '';
        qs('newTaskDescription').value = '';
        render();
      });

      qs('saveTaskBtn').addEventListener('click', () => {
        saveCurrentTask();
      });

      qs('moveNowBtn').addEventListener('click', () => moveSelectedTask('now'));
      qs('moveNextBtn').addEventListener('click', () => moveSelectedTask('next'));
      qs('moveBlockedBtn').addEventListener('click', () => moveSelectedTask('blocked'));
      qs('moveDoneBtn').addEventListener('click', () => moveSelectedTask('done'));

      qs('focusFirstActionBtn').addEventListener('click', () => focusFirstAction());
      qs('focusNowBtn').addEventListener('click', () => focusTopTask('now'));
      qs('focusBlockedBtn').addEventListener('click', () => focusTopTask('blocked'));
      qs('focusNextBtn').addEventListener('click', () => focusTopTask('next'));

      qs('deleteTaskBtn').addEventListener('click', () => {
        const task = getTaskById(app.selectedTaskId);
        if (!task) return;
        if (!confirm(`Delete task "${task.title}"?`)) return;
        app.state.tasks = app.state.tasks.filter((t) => t.id !== task.id);
        app.selectedTaskId = null;
        addFeed('Task deleted: ' + task.title, 'change');
        persist();
        render();
        flashAction('Task deleted.', 'ok');
      });

      qs('openTaskLinkBtn').addEventListener('click', () => {
        const task = getTaskById(app.selectedTaskId);
        if (!task) {
          flashAction('Select a task first.', 'warn');
          return;
        }
        if (!task.link) {
          flashAction('Add a link in task details first.', 'warn');
          return;
        }
        window.open(task.link, '_blank', 'noopener');
        flashAction('Opened task link in a new tab.', 'ok');
      });

      qs('copyPromptBtn').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(qs('prompt').textContent);
          qs('copyPromptBtn').textContent = 'Copied';
          setTimeout(() => qs('copyPromptBtn').textContent = 'Copy execution brief', 1000);
          flashAction('Execution brief copied.', 'ok');
        } catch {
          qs('copyPromptBtn').textContent = 'Copy failed';
          setTimeout(() => qs('copyPromptBtn').textContent = 'Copy execution brief', 1200);
          flashAction('Copy failed. Select the brief and press ⌘C.', 'warn');
        }
      });

      qs('exportBtn').addEventListener('click', () => {
        downloadJson('mission-control-board.json', app.state);
        flashAction('Board JSON exported.', 'ok');
      });

      qs('importBtn').addEventListener('click', () => {
        qs('importInput').click();
        flashAction('Select a JSON file to import.', 'info');
      });
      qs('importInput').addEventListener('change', async (evt) => {
        const file = evt.target.files?.[0];
        if (!file) return;
        try {
          const text = await file.text();
          const parsed = JSON.parse(text);
          app.state = createDefaultState(parsed);
          app.selectedTaskId = app.state.tasks[0]?.id || null;
          addFeed('Board imported from JSON', 'change');
          persist();
          render();
          flashAction('Board imported from JSON.', 'ok');
        } catch {
          flashAction('Import failed: use a valid board JSON export.', 'warn');
          addFeed('Import failed: invalid JSON file format', 'warn');
          renderFeed();
        }
      });

      qs('resetBtn').addEventListener('click', () => {
        if (!confirm('Reset board to baseline state.json?')) return;
        app.state = createDefaultState(app.baseline);
        app.selectedTaskId = app.state.tasks[0]?.id || null;
        addFeed('Board reset to baseline', 'change');
        persist();
        render();
        flashAction('Board reset to baseline.', 'ok');
      });

      qs('pullNextBtn').addEventListener('click', () => {
        const nextTask = sortedTasks('next')[0];
        if (!nextTask) {
          flashAction('No tasks in Next lane.', 'warn');
          return;
        }
        app.selectedTaskId = nextTask.id;
        moveSelectedTask('now');
      });

      qs('unblockTopBtn').addEventListener('click', () => {
        const blockedTask = sortedTasks('blocked')[0];
        if (!blockedTask) {
          flashAction('No tasks in Blocked lane.', 'warn');
          return;
        }
        app.selectedTaskId = blockedTask.id;
        moveSelectedTask('next');
      });

      qs('strikeNoteAddBtn').addEventListener('click', () => {
        const note = qs('strikeNoteInput').value.trim();
        if (!note) return;
        app.state.strikeDesk.notes.push(note);
        app.state.strikeDesk.notes = app.state.strikeDesk.notes.slice(-20);
        qs('strikeNoteInput').value = '';
        persist();
        render();
        flashAction('Strike note added.', 'ok');
      });

      qs('copyStrikeBriefBtn').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(buildStrikeBrief());
          flashAction('Strike brief copied.', 'ok');
        } catch {
          flashAction('Strike brief copy failed. Select text and press ⌘C.', 'warn');
        }
      });

      qs('feedAddBtn').addEventListener('click', () => {
        const text = qs('feedInput').value.trim();
        if (!text) return;
        addFeed(text, 'note');
        qs('feedInput').value = '';
        persist();
        render();
        flashAction('Feed update added.', 'ok');
      });
    }

    async function init() {
      nowClock();
      setInterval(nowClock, 1000);

      app.baseline = await loadBaseline();
      const baseState = createDefaultState(app.baseline);
      const persisted = loadPersisted();
      app.state = persisted ? createDefaultState(persisted) : baseState;
      app.selectedTaskId = app.state.tasks[0]?.id || null;

      wireActions();
      render();
    }

    init();
  </script>
</body>
</html>
